// procedure without cursor
CREATE OR REPLACE PROCEDURE EMPLOYEE2DEPARTMENT 
IS
DECLARE
	IALLOC	  NUMBER(2);
	ILIMIT	  NUMBER(2);
	ICNT      NUMBER(2);
BEGIN
	DELETE FROM EMPLOYEE_DEPARTMENT;
	DELETE FROM DEPARTMENT_SALARY;
    FOR E IN (SELECT EMPLOYEE_ID FROM EMPLOYEES ORDER BY HIRE_DATE)
    LOOP
        FOR O IN (SELECT DEPARTMENT_ID FROM OPTIONS WHERE EMPLOYEE_ID = E.EMPLOYEE_ID ORDER BY CHOICE)
				LOOP
					SELECT COUNT(*) INTO ICNT FROM LIMITS WHERE DEPARTMENT_ID = O.DEPARTMENT_ID;
					ILIMIT := 0;
					IF ICNT > 0 THEN  
						SELECT LIMIT INTO ILIMIT FROM LIMITS WHERE DEPARTMENT_ID = O.DEPARTMENT_ID;
					END IF;
					SELECT COUNT(*) INTO IALLOC FROM EMPLOYEE_DEPARTMENT WHERE DEPARTMENT_ID = O.DEPARTMENT_ID;
					IF ILIMIT = 0 OR IALLOC < ILIMIT THEN  
						INSERT INTO EMPLOYEE_DEPARTMENT VALUES(E.EMPLOYEE_ID, O.DEPARTMENT_ID);
						EXIT;
					END IF;
				END LOOP;
    END LOOP;
END;
/

// procedure with cursor
CREATE OR REPLACE PROCEDURE EMPLOYEE2DEPARTMENT 
IS  
DECLARE
	CURSOR ICUR IS SELECT EMPLOYEE_ID FROM EMPLOYEES ORDER BY HIRE_DATE;
	CURROW ICUR%ROWTYPE;
	IEMPLOYEE NUMBER(6);
	IDEPT     NUMBER(4);
	IALLOC	  NUMBER(2);
	ILIMIT	  NUMBER(2);
	ICNT      NUMBER(2);
BEGIN
	DELETE FROM EMPLOYEE_DEPARTMENT;
	DELETE FROM DEPARTMENT_SALARY;
	OPEN ICUR;
	LOOP
		FETCH ICUR INTO CURROW;
					EXIT WHEN ICUR%NOTFOUND;
								IEMPLOYEE := CURROW.EMPLOYEE_ID;
								FOR I IN 1..27
									LOOP
										SELECT DEPARTMENT_ID INTO IDEPT FROM OPTIONS WHERE EMPLOYEE_ID = IEMPLOYEE AND CHOICE = I;
										SELECT COUNT(*) INTO ICNT FROM LIMITS WHERE DEPARTMENT_ID = IDEPT;
										ILIMIT := 0;
										IF ICNT > 0 THEN  
												SELECT LIMIT INTO ILIMIT FROM LIMITS WHERE DEPARTMENT_ID = IDEPT;
										END IF;
										SELECT COUNT(*) INTO IALLOC FROM EMPLOYEE_DEPARTMENT WHERE DEPARTMENT_ID = IDEPT;
										IF ILIMIT = 0 OR IALLOC < ILIMIT THEN  
											INSERT INTO EMPLOYEE_DEPARTMENT VALUES(IEMPLOYEE, IDEPT);
											EXIT;
										END IF;
									END LOOP;
		END LOOP;
	CLOSE ICUR;
END;
/


// trigger

CREATE OR REPLACE TRIGGER DEPARTMENT2SALARY
AFTER INSERT ON EMPLOYEE_DEPARTMENT
FOR EACH ROW
DECLARE
	IEMPLOYEE NUMBER(6);
	IDEPT     NUMBER(4);
	ISALARY	NUMBER(8, 2);
	ICNT      NUMBER(2);
BEGIN
	IEMPLOYEE := :NEW.EMPLOYEE_ID;
	IDEPT := :NEW.DEPARTMENT_ID;
	SELECT COUNT(*) INTO ICNT FROM DEPARTMENT_SALARY WHERE DEPARTMENT_ID = IDEPT;
	SELECT SALARY INTO ISALARY FROM EMPLOYEES WHERE EMPLOYEE_ID = IEMPLOYEE;
	IF ICNT > 0 THEN
		UPDATE DEPARTMENT_SALARY SET TOTAL_SALARY = TOTAL_SALARY + ISALARY WHERE DEPARTMENT_ID = IDEPT;
	ELSE	
		INSERT INTO DEPARTMENT_SALARY VALUES (IDEPT, ISALARY);
	END IF;
END;
/

